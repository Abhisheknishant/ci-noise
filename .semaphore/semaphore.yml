version: v1.0
name: Build
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: CI
    task:
      jobs:
        - name: GCC
          commands:
            - cat /proc/cpuinfo
            - checkout
            - git submodule update --init
            - sudo apt-get update && sudo apt-get install -y ninja-build parallel python3-pip python3-setuptools gcovr
            - pip3 install meson
            - mkdir build
            - meson setup build -Db_coverage=true
            - ninja -C build -v
            - './build/test/run-tests --list | grep -oP ''^/([^\/]+)/([^\/]+)'' | sort -u | xargs parallel ./build/test/run-tests --color always {} :::'
            - ninja coverage-xml
      env_vars:
        - name: GCC_VERSION
          value: '8'
        - name: CFLAGS
          value: '-Wextra -Werror -march=native'
        - name: CXXFLAGS
          value: '-Wextra -Werror -march=native'
        - name: CC
          value: gcc
        - name: CXX
          value: g++
